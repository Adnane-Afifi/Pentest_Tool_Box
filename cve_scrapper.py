#!/usr/bin/env python3

from bs4 import BeautifulSoup
import colorama
import requests
import weasyprint
import os


def SearchExploit():
    buf = ''
    htmlContent = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport de pentest</title>
    <style>
        body {
            padding: 0px;
            margin: 0px;
            margin-top: -25px;
            font-family: Arial, Helvetica, sans-serif;
        }
        #cve-title {
            padding: 20px;
            font-size: 2em;
            font-weight: bold;
        }
        #title-container {
            padding-top: 20px;
            padding-left: 20px;
            background-color: #327dbf;
            display: flex;
            align-items: center;
        }
        p {
            padding-left: 10px;
        }
        #cve-id {
            color: black;
            font-size: 1.2em;
            font-weight: bold;
        }
        #cve-description {
            color: black;
            font-size: 1.2em;
            font-weight: normal;
        }
        #cve-list p {
            margin-bottom: 5px;
            border-bottom: solid black 1px;
        }
        #cve-header {
            display: flex;
        }
        #cve-header a {
            flex-align: space-between;
            padding-right: 200px;
            font-size: 1.8em;
        }
        img {
            width: 100px;
        }
    </style>
</head>
<body>
    <div id="title-container">
        <img src="supdevinci.png" alt="supdevinci logo">   
        <h1 id="cve-title">Rapport des CVE</h1>
    </div>
    <div id="cve-list"><p id="cve-header" style="font-weight: bold"><a>CVE ID</a><a>Description de la CVE</a></p>"""

    product = input("Nom du produit que vous cherchez : ")
    version = input("Version du produit (laisser vide si inconnue) : ")

    while True:
        pdfOrHtml = str(input("Souhaitez vous un rapport en page html ou en pdf ? (1. HTML / 2. PDF) : "))
        if pdfOrHtml == '1' or pdfOrHtml == '2':
            break
        else:
            print(pdfOrHtml)
            print(type(pdfOrHtml))
            print(colorama.Fore.YELLOW + "Veuillez choisir 1 ou 2 !" + colorama.Style.RESET_ALL)

    url = f"https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword={product}+{version}"
    headers = {'User-Agent': 'Mozilla/5.0 (compatible; MSIE 11.0; Windows NT 5.0; Trident/5.0)'}
    try:
        req = requests.get(url, headers=headers)
        if req.status_code == 200:
            soup = BeautifulSoup(req.content, "html.parser")
            divTag = soup.findAll('div', id='TableWithRules')
            for tag in divTag:
                divTag = tag.findAll('td', {'valign': 'top'})
                for i in divTag:
                    buf += f"{i.text}§"
                    temp = str(buf).replace('\n', '')
                    exploitTable = temp.split('§')
            for j in range(0, len(exploitTable) - 1, 2):
                #print(colorama.Fore.GREEN + f"{exploitTable[j]}" + colorama.Style.RESET_ALL + f" : {exploitTable[j+1]}")
                htmlContent += f"<p><a id=\"cve-id\">{exploitTable[j]} : </a><a id=\"cve-description\">{exploitTable[j+1]}</a></p>"
            htmlContent += "</div></body></html>"

            if pdfOrHtml == '1':
                with open("cveoutput.html", "w") as file:
                    file.write(htmlContent)
                    file.close()
            else:
                base_url = os.path.dirname(os.path.realpath(__file__))
                pdf = weasyprint.HTML(string=htmlContent, base_url=base_url)
                pdf.write_pdf('cveoutput.pdf')
        else:
            print(colorama.Fore.RED + "Il y a eu une erreur lors de la requête" + colorama.Style.RESET_ALL)
    except Exception as e:
        print(colorama.Fore.RED + f"Il y a eu une erreur qui est : {e}" + colorama.Style.RESET_ALL)


def main():
    SearchExploit()


if __name__ == '__main__':
    main()
