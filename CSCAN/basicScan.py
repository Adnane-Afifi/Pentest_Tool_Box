import nmap
from jinja2 import Template
import os
import requests
from bs4 import BeautifulSoup


def get_options(options):
    for key, value in options.items():
        print(f"{key}")
    sub_option = input("Enter your choice: ")
    for key, value in options.items():
        print(key.__contains__(sub_option))
        if key.__contains__(sub_option):
            return key
        else:
            continue
    print("Invalid option")
    get_options(options)


def render_template(template_string, **kwargs):
    template = Template(template_string)
    return template.render(**kwargs)


# Test for more than one host to check the output
# TODO
def generate_html_report(host, scan_results):
    template = """
    <html>
    <head>
        <title>Nmap Scan Results</title>
    </head>
    <body>
     {% for hosts,hosts_info in scan_results.items() %}
        <h1>Nmap Scan Results for {{ hosts }}</h1>
        <table>
            <tr>
                <th>Port</th>
                <th>Protocol</th>
                <th>State</th>
                <th>Service</th>
            </tr>
           {% for port, info in hosts_info.items() %}
            <tr>
                <td>{{ port }}</td>
                <td>{{ info['protocol'] }}</td>
                <td>{{ info['state'] }}</td>
                <td>{{ info['name'] }}</td>
            {% endfor %}
            </tr>
        </table>
            {% endfor %}
    </body>
    </html>
    """
    html_report = render_template(template, host=host, scan_results=scan_results)
    with open('nmap_report.html', 'w') as f:
        f.write(html_report)
    return html_report


'''
The user have to precise the type of scan that he want and then accordinatly to the basic scan that he choose the scan 
will be realeased :
TCP
SYN 
UDP
'''


def basic_scan(host):
    # if os.geteuid() != 0:
    #     print("This script requires root privilege. Please run it with 'sudo'.")
    #     return None
    custom_nmap = nmap.PortScanner()
    basic_type_scan = {'1. Tcp scan': 'sT', '2. Syn Scan': 'sS', '3. Udp scan': 'U'}
    type = get_options(basic_type_scan)
    print(type)
    custom_nmap.scan(hosts=host, arguments='-' + str(basic_type_scan[str(type)]))
    scan_results = {}
    print(custom_nmap.all_hosts())
    for host in custom_nmap.all_hosts():
        host_results = {}
        if ('tcp' or 'udp') in custom_nmap[host]:
            for port in custom_nmap[host]['tcp']:
                info = custom_nmap[host]['tcp'][port]
                host_results[port] = {
                    'protocol': 'tcp',
                    'state': info['state'],
                    'name': info['name']
                }
        scan_results[host] = host_results
        print(scan_results)
    html_report = generate_html_report(host,scan_results)
    return html_report

# htm_reprot = basic_scan("10.10.153.3")
# print(htm_reprot)


